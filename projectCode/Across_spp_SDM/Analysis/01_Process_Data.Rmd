---
title: 'Step 1: Process Data'
author: "Lizbeth G Amador"
date: "2025-04-09"
output: html_document
---

pre-process data for phenology, species occurence, and climate.   

# Presets 
```{r, warning=FALSE, message=FALSE}
# Load necessary libraries
#if statement to automatically install libraries if absent in r library
#tidyverse - mainly for data wrangling & plotting/mapping
if (!requireNamespace("tidyverse", quietly = TRUE)) {
  install.packages("tidyverse")
}
library(tidyverse)

#terra - spatial package 
if (!requireNamespace("terra", quietly = TRUE)) {
  install.packages("terra")
}
require(terra)

#sf - spatial package (required for some computational packages) 
if (!requireNamespace("sf", quietly = TRUE)) {
  install.packages("sf")
}
require(sf)

#tidyterra - spatial package for mapping 
if (!requireNamespace("tidyterra", quietly = TRUE)) {
  install.packages("tidyterra")
}
require(tidyterra)


#usdm -- colinearity stuff 
if (!requireNamespace("usdm", quietly = TRUE)) {
  install.packages("usdm")
}
require(usdm)

#CoordinateCleaner -- to clean coordinates by multiple tests 
if (!requireNamespace("CoordinateCleaner", quietly = TRUE)) {
  install.packages("CoordinateCleaner")
}
require(CoordinateCleaner)
```

Directories 
```{r}
#Liz's personal direct -- data also found on Cyverse 
L1 = "G:/Shared drives/MSB_Phenology/Amador/Amador, Liz-Phenology Dissertation 2023/Chapters/Chapter4/Data/L1"
L1.ppt = "G:/Shared drives/MSB_Phenology/Amador/Amador, Liz-Phenology Dissertation 2023/Chapters/Chapter4/Data/L1/PRISM/ppt" 
L1.temp = "G:/Shared drives/MSB_Phenology/Amador/Amador, Liz-Phenology Dissertation 2023/Chapters/Chapter4/Data/L1/PRISM/temp"
# L2 = "G:/Shared drives/MSB_Phenology/Amador/Amador, Liz-Phenology Dissertation 2023/Chapters/Chapter4/Data/L2"
```

```{r}
#ESIIL Macrophenology group - for saving 
main.dir = "G:/Shared drives/ESIIL_Macrophenology/Across_sp_SDM"
L2 = file.path(main.dir, "Data/L2")
```



**1. Process data  **

Pre-process the climate data and the phenological data to prepare for analysis.  


# Climate Data  
## i. Precipitation 
```{r}
#precipitation 
#annual spring averages
ppt.asa = rast(file.path(L1.ppt, #object saving directory 
                         "prism_ppt_Annual_SpringAvg.tif"))
```

Split the annual spring averages between historical and current. 
```{r}
#annual spring averages - historic 
ppt.asah = ppt.asa[[1:41]]
#annual spring averages - current 
ppt.asac = ppt.asa[[42:81]]
```


## ii. Temperature 
```{r}
#temperature
#annual spring averages 
temp.asa = rast(file.path(L1.temp, #object saving directory
                          "prism_temp_Annual_Spring_Avg.tif"))
```

Split the annual spring averages between historical and current. 
```{r}
#annual spring averages - historic 
temp.asah = temp.asa[[1:41]]
#annual spring averages - current 
temp.asac = temp.asa[[42:80]]
```


### Reproject 
Let's make sure the precipitation and temperature rasters are in the same projection! Note: precipitation/temperature rasters were calculated in their respective workflows, so within temp/precip groups are the same projection. 
```{r}
crs(ppt.asa) == crs(temp.asa)
```

The precipitation and temperature data are not in the same projection so we will reproject them. 
```{r}
temp.asa <- project(temp.asa, #raster we want to reproject
                                 crs(ppt.asa)) #reference raster

temp.asah <- project(temp.asah, #raster we want to reproject
                                 crs(ppt.asa)) #reference raster

temp.asac <- project(temp.asac, #raster we want to reproject
                                 crs(ppt.asa)) #reference raster 
```

```{r}
#double checking 
crs(temp.asah) == crs(ppt.asa)
```

```{r}
#import study area - CONUS 
conus = vect(file.path(L1, #object saving directory
                       "NEON_Domains_CONUS.shp"), crs = crs(ppt.asa))

#check that phe.sh and conus have same crs
# crs(conus) == crs(ppt.asa)

#save with reprojection
writeVector(conus, file.path(L2, #object saving directory 
                             "conus.shp"))
```

```{r}
#Checking to see if they overlap well
plot(ppt.asa[[1]])
plot(conus, add = TRUE)
```

Great! Now the climate data have been distinguished between the two time periods and are in the same projection.


## iiii. Raster stacks 
We will summarise all years within each variable (i.e. mean annual averages & mean annual anomalies). After that we will stack the climate variables for each respective time period to use in the modeling.  
```{r}
#Precipitation 
#Historical annual spring avg -- ppt
ppt.asah.avg = app(ppt.asah, mean, na.rm = TRUE)
#Current annual spring avg -- ppt
ppt.asac.avg = app(ppt.asac, mean, na.rm = TRUE)


#Temperature 
#Historical annual spring avg -- temp
temp.asah.avg = app(temp.asah, mean, na.rm = TRUE)
#Current annual spring avg -- temp
temp.asac.avg = app(temp.asac, mean, na.rm = TRUE)

```

Average across years for both time periods to get the overall average (i.e. normals). We have the precipitation and temperature for all years already, from the very beginning when reading in the climate data. We will use this to calculate anomalies for each time period.  
```{r}
#ppt avg 
ppt.avg = app(ppt.asa, mean, na.rm = TRUE)
#temp avg 
temp.avg = app(temp.asa, mean, na.rm = TRUE)
```

Calculate anomalies 
```{r}
#ppt 
#historical
ppt.anom.hist = ppt.asah.avg - ppt.avg
#current 
ppt.anom.cur = ppt.asac.avg - ppt.avg

#temp
#historical
temp.anom.hist = temp.asah.avg - temp.avg
#current 
temp.anom.cur = temp.asac.avg - temp.avg
```

Combining all the time period specific variables together 
```{r}
#Historical 
clim.h = c(ppt.asah.avg, ppt.anom.hist, temp.asah.avg, temp.anom.hist)
#Changing column names 
names(clim.h) <- c("ppt.avg", "ppt.anom", "temp.avg", "temp.anom")

#Current  
clim.c = c(ppt.asac.avg, ppt.anom.cur, temp.asac.avg, temp.anom.cur)
#Changing column names 
names(clim.c) <- c("ppt.avg", "ppt.anom", "temp.avg", "temp.anom")
```

```{r}
plot(clim.h)
plot(clim.c)
```

```{r, echo=FALSE}
# #uncomment to save 
# graph.out = "./Graphs"
# png(file = file.path(graph.out, "Map_Historical_ClimateStack.png"))
# plot(clim.h)
# dev.off()
# 
# #current 
# png(file = file.path(graph.out, "Map_Current_ClimateStack.png"))
# plot(clim.c)
# dev.off()
```



## iv. Colinearity 

Predictor climate variables are often highly correlated, and modeling with correlated variables can lead to inaccurate results, so we will remove those with the highest variance inflation factor (VIF), a measure of variable correlation.

### Historic 
```{r}
# Now we will remove those variables from consideration that have a high VIF.
envs.vif <- usdm::vifstep(clim.h)
envs.rem <- envs.vif@excluded
clim.h <- clim.h[[!(names(clim.h) %in% envs.rem)]]
#check the rasters inside
names(clim.h)
```

```{r, include=FALSE}
plot(clim.h[[1]], main = names(clim.h[[1]]))
```

### Current 
```{r}
# Now we will remove those variables from consideration that have a high VIF.
envs.vif <- usdm::vifstep(clim.c)
envs.rem <- envs.vif@excluded
clim.c <- clim.c[[!(names(clim.c) %in% envs.rem)]]
#check the rasters inside
names(clim.c)
```

```{r, include=FALSE}
plot(clim.c[[1]], main = names(clim.c[[1]]))
```


Removing extra spatRast/Vect obj from enviro data -- takes up too much memory 
```{r}
rm(list = ls(pattern = c("^temp", "^ppt"))) #^ only search for strings beginning with the pattern 
```

```{r}
#save the climate data - so we don't have to run again for other scripts  
#historic
writeRaster(clim.h, file = file.path(L2, #object saving directory
                                     "ClimRastS_H_cleaned.tif"))
#current 
writeRaster(clim.c, file = file.path(L2, #object saving directory
                                     "ClimRastS_C_cleaned.tif"))
```

# Phenology Data 
Now we will read in the phenological data 
```{r}
#import phenology data 
phe = read.csv(file.path(L2, #object saving directory
                         "FocalSpp_OpenFlowers_NeonNpnHerb_iDigBio.csv"), header = TRUE)
```

Let's clean up the data frame 

Here we want to make sure the data points fall within the CONUS extent.
```{r}
#Making sure observations fall within CONUS extent 
#turn into a point vector 
phe.sh = vect(phe, geom = c("longitude", "latitude"), keep = TRUE, crs = crs(conus))
plot(conus, main = "All Phenological Observations"); plot(phe.sh, add=TRUE)

phe.sh = phe.sh %>% 
  select(-DomainID)

#drop any points outside of conus shapefile 
phe.int = intersect(phe.sh, conus)
plot(conus, main="All Phenological Obs: Post intersect"); plot(phe.int, add=TRUE)

#revert back to a dataframe 
phe.conus = as.data.frame(phe.int)
```

We will now limit species to those we are interested in. 
```{r}
#remove extra species 
phe = phe.conus %>%
  filter(!species %in% c("Acer saccharum", "Hymenocallis occidentalis", 
                         "Ilex aquifolium", "Acer palmatum", "Juglans regia", 
                         "Hymenocallis littoralis")) %>% 
  dplyr::select(latitude, longitude, day_of_year, year_rect, native_status, 
                species, phenophase_status, data_name) 

```

Let's split the data into the two time periods.  
```{r}
#Historical
phe.hist = phe.conus %>%
  filter(year_rect >= 1910, year_rect <= 1950)
#Current 
phe.cur = phe.conus %>%
  filter(year_rect >= 1985)
```

```{r}
#save objects 
save(phe.hist, phe.cur, file = file.path(L2, "phenology_timeperiods.RData"))
#to import 
# load(file.path(L2, "phenology_timeperiods.RData"), verbose = TRUE)
```







